name: Weekly Processing Pipeline

on:
  schedule:
    # Run at 10 AM UTC every Sunday
    - cron: '0 10 * * 0'
  workflow_dispatch:
    inputs:
      week:
        description: 'Week to process (YYYY-WXX, e.g., 2024-W31)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.12'

jobs:
  process-weekly-data:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour timeout for weekly batches
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 📦 Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib python-dotenv
        
    - name: 🔑 Setup Credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT }}
      run: |
        mkdir -p .credentials
        echo "$GOOGLE_CREDENTIALS" | base64 -d > .credentials/google-drive-service-account.json
        chmod 600 .credentials/google-drive-service-account.json
        
    - name: 🔧 Create Environment Configuration
      run: |
        cat > .env << EOF
        GOOGLE_DRIVE_SERVICE_ACCOUNT=.credentials/google-drive-service-account.json
        DAILY_FOLDER_ID=${{ secrets.DAILY_FOLDER_ID }}
        WEEKLY_FOLDER_ID=${{ secrets.WEEKLY_FOLDER_ID }}
        GITHUB_USERNAME=${{ github.repository_owner }}
        TRADINGVIEW_NAMESPACE=${{ secrets.TRADINGVIEW_NAMESPACE }}
        PROCESSING_MODE=production
        MAX_FILES_PER_BATCH=100
        PARALLEL_WORKERS=4
        SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
        EOF
        
    - name: 📅 Set Processing Week
      id: week
      run: |
        if [ -n "${{ github.event.inputs.week }}" ]; then
          echo "WEEK=${{ github.event.inputs.week }}" >> $GITHUB_OUTPUT
        else
          # Calculate current week in YYYY-WXX format
          echo "WEEK=$(date -u +'%Y-W%V')" >> $GITHUB_OUTPUT
        fi
        echo "Processing week: $(cat $GITHUB_OUTPUT)"
        
    - name: 📥 Download and Process Weekly Data
      run: |
        python process_from_drive.py --timeframe weekly --date ${{ steps.week.outputs.WEEK }}
        
    - name: 🔍 Verify Output
      run: |
        echo "Checking output directory..."
        echo "=== Directory contents ==="
        ls -la data/output/weekly/${{ steps.week.outputs.WEEK }}/ || echo "No output found"
        echo "=== CSV files found ==="
        find data/output/weekly/${{ steps.week.outputs.WEEK }} -name "*.csv" -type f || echo "No CSV files found"
        echo "=== File contents preview ==="
        for file in data/output/weekly/${{ steps.week.outputs.WEEK }}/*.csv; do
          if [ -f "$file" ]; then
            echo "File: $file"
            head -3 "$file"
            echo "---"
          fi
        done
        
        
    - name: 📋 Pre-deployment Check
      if: success()
      run: |
        echo "=== Files to deploy ==="
        ls -la data/output/weekly/${{ steps.week.outputs.WEEK }}/
        echo "=== File timestamps ==="
        stat data/output/weekly/${{ steps.week.outputs.WEEK }}/*.csv || true
        
    - name: 🚀 Deploy to GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./data/output/weekly/${{ steps.week.outputs.WEEK }}
        destination_dir: data/weekly
        keep_files: true
        force_orphan: false
        commit_message: "Deploy weekly data for ${{ steps.week.outputs.WEEK }}"
        
    - name: 📊 Generate Summary
      if: always()
      run: |
        echo "## Weekly Processing Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Week: ${{ steps.week.outputs.WEEK }}" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        if [ -d "data/output/weekly/${{ steps.week.outputs.WEEK }}" ]; then
          echo "- Files processed: $(ls -1 data/output/weekly/${{ steps.week.outputs.WEEK }}/*.csv 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        fi